<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NOVA · Clients Full List</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="نوفا">
    <link rel="manifest" href="manifest.json">
    
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --accent: #3b82f6;
            --bg: #f4f7fa;
            --card: #ffffff;
            --text: #1e293b;
            --muted: #94a3b8;
            --success: #10b981;
            --danger: #ef4444;
            --nova-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Almarai', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); padding: 15px 12px 100px; }

        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding: 5px 10px; }
        .brand-area { display: flex; align-items: center; gap: 12px; }
        .brand-logo { width: 45px; height: 45px; border-radius: 14px; object-fit: cover; border: 2px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .top-bar h1 { font-size: 22px; font-weight: 800; }

        .stats-mega-card {
            background: var(--nova-gradient); border-radius: 32px; padding: 25px;
            box-shadow: 0 20px 40px rgba(15, 23, 42, 0.25);
            margin-bottom: 25px; color: white;
        }
        .stat-main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stat-full-width { grid-column: span 2; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; margin-bottom: 10px; }
        .stat-item { display: flex; flex-direction: column; }
        .stat-label { font-size: 10px; opacity: 0.6; margin-bottom: 4px; }
        .stat-value { font-size: 17px; font-weight: 800; }
        .stat-value.large { font-size: 28px; color: var(--success); }
        .stat-value.gold { color: #fbbf24; }

        .mini-stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 20px; }
        .mini-box { background: rgba(255,255,255,0.1); padding: 10px 2px; border-radius: 15px; text-align: center; cursor: pointer; color: white; border: 1px solid rgba(255,255,255,0.05); }
        .mini-box.active-filter { background: white; color: #0f172a; }

        .search-box { position: relative; margin-bottom: 20px; }
        .search-box i { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--muted); }
        .search-box input { width: 100%; padding: 14px 45px 14px 15px; background: var(--card); border: 1.5px solid #e2e8f0; border-radius: 18px; outline: none; }

        .client-card { background: var(--card); border-radius: 28px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); position: relative; border: 1px solid #fff; }
        .edit-btn-top { position: absolute; left: 15px; top: 15px; background: #f1f5f9; width: 38px; height: 38px; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--accent); cursor: pointer; }
        
        .card-header { margin-bottom: 15px; }
        .track-pill { background: #eff6ff; color: var(--accent); padding: 4px 12px; border-radius: 10px; font-size: 11px; font-weight: 800; }
        .client-name { font-size: 19px; font-weight: 800; display: block; margin-top: 8px; color: #0f172a; }

        .contact-links { display: flex; gap: 10px; margin: 15px 0; }
        .btn-link { flex: 1; padding: 10px; border-radius: 12px; background: #f8fafc; text-decoration: none; color: var(--text); font-size: 12px; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 8px; border: 1px solid #e2e8f0; }

        .status-tag { display: inline-flex; align-items: center; gap: 6px; padding: 6px 14px; border-radius: 12px; font-size: 11px; font-weight: 800; cursor: pointer; }
        .status-tag.paid { background: #dcfce7; color: #166534; }
        .status-tag.unpaid { background: #fee2e2; color: #991b1b; }

        .finance-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; background: #f8fafc; padding: 15px; border-radius: 20px; margin: 15px 0; }
        .f-box { text-align: center; }
        .f-label { font-size: 9px; font-weight: 700; color: var(--muted); display: block; margin-bottom: 2px; }
        .f-value { font-size: 12px; font-weight: 800; }

        .note-text { font-size: 12px; color: #b45309; background: #fffbeb; padding: 12px; border-radius: 15px; margin-bottom: 15px; border: 1px dashed #fcd34d; }

        .profit-bar { background: #1e293b; color: white; padding: 14px 18px; border-radius: 18px; display: flex; justify-content: space-between; align-items: center; }
        .profit-bar.pending { background: #e2e8f0; color: #94a3b8; }

        .action-row { display: grid; grid-template-columns: 1fr auto; gap: 10px; margin-top: 15px; }
        .btn-base { border: none; padding: 12px; border-radius: 15px; font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-inv { background: var(--accent); color: white; flex-grow: 1; text-decoration: none; }
        .btn-del { background: #fff1f2; color: var(--danger); width: 50px; }

        .nav-dock { position: fixed; bottom: 15px; left: 15px; right: 15px; background: #0f172a; border-radius: 24px; padding: 12px; display: flex; justify-content: space-around; z-index: 1000; }
        .nav-link { color: #64748b; text-decoration: none; font-size: 20px; }
        .nav-link.active { color: #fff; }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="brand-area">
            <img src="img/logo.png" alt="Logo" class="brand-logo">
            <h1>العملاء<span style="color:var(--accent)">.</span></h1>
        </div>
    </div>

    <div class="stats-mega-card">
        <div id="pStats" class="stat-main-grid"></div>
        <div class="mini-stats-grid">
            <div class="mini-box" id="f-all" onclick="setFilter('all')"><span id="count-all" class="m-val">0</span><span class="m-lab">الكل</span></div>
            <div class="mini-box" id="f-paid" onclick="setFilter('paid')"><span id="count-paid" class="m-val">0</span><span class="m-lab">مدفوع</span></div>
            <div class="mini-box" id="f-unpaid" onclick="setFilter('unpaid')"><span id="count-unpaid" class="m-val">0</span><span class="m-lab">معلق</span></div>
            <div class="mini-box"><span id="count-avg" class="m-val">0</span><span class="m-lab">متوسط</span></div>
        </div>
    </div>

    <div class="search-box">
        <i class="fas fa-search"></i>
        <input type="text" id="q" placeholder="ابحث بالاسم أو رقم التتبع..." oninput="draw()">
    </div>

    <div id="list"></div>

    <nav class="nav-dock">
        <a href="dashboard.html" class="nav-link"><i class="fas fa-chart-pie"></i></a>
        <a href="index.html" class="nav-link"><i class="fas fa-plus-circle"></i></a>
        <a href="vu.html" class="nav-link active"><i class="fas fa-users"></i></a>
        <a href="ads.html" class="nav-link"><i class="fas fa-coins"></i></a>
        <a href="total.html" class="nav-link"><i class="fas fa-calendar-alt"></i></a>
    </nav>

    <script>
        const KEY = 'nova_clients';
        let currentStatusFilter = 'all';

        const get = () => JSON.parse(localStorage.getItem(KEY) || '[]');
        const fmt = (v) => (v || 0).toLocaleString('ar-DZ') + ' دج';
        const fmtUSD = (v) => '$' + (Number(v) || 0).toFixed(2);

        // وظيفة الانتقال للفاتورة (الإصلاح الجديد)
        function goToInvoice(id) {
            sessionStorage.setItem('invoiceClientId', id);
            window.location.href = 'invoice.html';
        }

        function setFilter(status) {
            currentStatusFilter = status;
            document.querySelectorAll('.mini-box').forEach(b => b.classList.remove('active-filter'));
            if(status !== 'all') document.getElementById('f-' + status).classList.add('active-filter');
            else document.getElementById('f-all').classList.add('active-filter');
            draw();
        }

        function draw() {
            const all = get();
            const q = document.getElementById('q').value.toLowerCase();
            
            const paidArr = all.filter(c => c.paid);
            const totalSales = paidArr.reduce((a,c) => a + (Number(c.amountPaidDZD) || 0), 0);
            const totalExpUSD = paidArr.reduce((a,c) => a + (Number(c.serviceExpenseUSD) || 0), 0);
            const totalExpDZD = paidArr.reduce((a,c) => a + ((Number(c.serviceExpenseUSD) || 0) * (Number(c.dollarRate) || 0)), 0);
            const totalNet = totalSales - totalExpDZD;

            document.getElementById('pStats').innerHTML = `
                <div class="stat-full-width">
                    <span class="stat-label">صافي الربح المحقق</span>
                    <div class="stat-value large">${fmt(totalNet)}</div>
                </div>
                <div class="stat-item"><span class="stat-label">المبيعات</span><div class="stat-value">${fmt(totalSales)}</div></div>
                <div class="stat-item"><span class="stat-label">المصاريف $</span><div class="stat-value gold">${fmtUSD(totalExpUSD)}</div></div>
                <div class="stat-item"><span class="stat-label">المصاريف DZD</span><div class="stat-value gold">${fmt(totalExpDZD)}</div></div>
                <div class="stat-item"><span class="stat-label">عدد المدفوعين</span><div class="stat-value">${paidArr.length}</div></div>
            `;

            document.getElementById('count-all').innerText = all.length;
            document.getElementById('count-paid').innerText = paidArr.length;
            document.getElementById('count-unpaid').innerText = all.length - paidArr.length;
            document.getElementById('count-avg').innerText = paidArr.length ? Math.round((totalSales/paidArr.length)/1000)+'k' : 0;

            let filtered = all.filter(c => (c.pageName||'').toLowerCase().includes(q) || (c.trackingNumber||'').toLowerCase().includes(q));
            if(currentStatusFilter==='paid') filtered = filtered.filter(c => c.paid);
            if(currentStatusFilter==='unpaid') filtered = filtered.filter(c => !c.paid);

            const container = document.getElementById('list');
            container.innerHTML = filtered.reverse().map(c => `
                <div class="client-card">
                    <div class="edit-btn-top" onclick="editClient('${c.id}')"><i class="fas fa-pen"></i></div>
                    <div class="card-header">
                        <span class="track-pill"># ${c.trackingNumber}</span>
                        <span class="client-name">${c.pageName}</span>
                        <div class="contact-links">
                            ${c.pageLink ? `<a href="${c.pageLink}" target="_blank" class="btn-link"><i class="fas fa-link"></i> رابط الصفحة</a>` : ''}
                            ${c.phone ? `<a href="tel:${c.phone}" class="btn-link"><i class="fas fa-phone"></i> اتصال</a>` : ''}
                        </div>
                        <div class="status-tag ${c.paid ? 'paid' : 'unpaid'}" onclick="toggle('${c.id}')">
                            <i class="fas ${c.paid ? 'fa-check-circle' : 'fa-clock'}"></i>
                            ${c.paid ? 'تم استلام الدفع' : 'في انتظار الدفع'}
                        </div>
                    </div>
                    <div class="finance-grid">
                        <div class="f-box"><span class="f-label">التاريخ</span><span class="f-value">${c.date}</span></div>
                        <div class="f-box"><span class="f-label">سعر الصرف</span><span class="f-value">${c.dollarRate}</span></div>
                        <div class="f-box"><span class="f-label">المبيعات</span><span class="f-value">${c.amountPaidDZD}</span></div>
                        <div class="f-box"><span class="f-label">مصاريف $</span><span class="f-value">${c.serviceExpenseUSD}</span></div>
                        <div class="f-box"><span class="f-label">المتابعين</span><span class="f-value">${c.followers || 0}</span></div>
                        <div class="f-box"><span class="f-label">الصافي</span><span class="f-value">${Math.round(c.netProfitDZD)}</span></div>
                    </div>
                    ${c.notes ? `<div class="note-text"><i class="fas fa-info-circle"></i> ${c.notes}</div>` : ''}
                    <div class="profit-bar ${c.paid ? '' : 'pending'}">
                        <span style="font-size:13px; font-weight:700;">صافي الربح</span>
                        <span style="font-size:18px; font-weight:800;">${c.paid ? fmt(c.netProfitDZD) : 'معلق'}</span>
                    </div>
                    <div class="action-row">
                        <button class="btn-base btn-inv" onclick="goToInvoice('${c.id}')"><i class="fas fa-file-invoice"></i> إصدار فاتورة</button>
                        <button class="btn-base btn-del" onclick="del('${c.id}')"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('') || '<div style="text-align:center; padding:30px; color:#94a3b8;">لا توجد سجلات</div>';
        }

        window.toggle = (id) => {
            let db = get();
            let i = db.findIndex(x => x.id === id);
            db[i].paid = !db[i].paid;
            localStorage.setItem(KEY, JSON.stringify(db));
            draw();
        };

        window.del = (id) => { if(confirm('هل تريد حذف هذا العميل نهائياً؟')) { localStorage.setItem(KEY, JSON.stringify(get().filter(x => x.id !== id))); draw(); } };
        window.editClient = (id) => { sessionStorage.setItem('editClientId', id); window.location.href = 'index.html'; };

        setFilter('all');
    </script>
</body>
</html>
